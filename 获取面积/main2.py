import cv2
import numpy as np
import math
'''
直接计算多边形面积来获得针孔面积，跟图像处理完全没有关系，只需要知道电容端面坐标集cap_points和针孔坐标集target_points
根据叉乘面积公式得出true_area
'''
class Point():
    def __init__(self,x,y):
        self.x = x
        self.y = y


def GetAreaOfPolyGonbyVector(points):
    # 基于向量叉乘计算多边形面积
    area = 0
    if(len(points)<3):

         raise Exception("error")

    for i in range(0,len(points)-1):
        p1 = points[i]
        p2 = points[i + 1]

        triArea = (p1.x*p2.y - p2.x*p1.y)/2
        area += triArea
    return abs(area)

def get_target_area(target):

    points = []
    x=[]
    y=[]
    for i in range(len(target)):
        x.append(target[i][0])
        y.append(target[i][1])
    # x = [1,2,3,4,5,6,5,4,3,2]
    # y = [1,2,2,3,3,3,2,1,1,1]
    for index in range(len(x)):
        points.append(Point(x[index],y[index]))

    area = GetAreaOfPolyGonbyVector(points)
    # print(area)
    return area

if __name__ == '__main__':
    path = r'D:\Files\MyData\images\E_pinhole_451.jpg'
    #1.设定参照物尺寸
    reference_width=1.3225
    reference_height=1.3225
    reference_area=reference_width*reference_height#前提参照物是矩形
    #2.电容端面坐标集
    cap_points=[
        [
            632.2340425531913,
            299.3829787234042
        ],
        [
            683.2978723404256,
            261.0851063829787
        ],
        [
            787.5531914893616,
            248.3191489361702
        ],
        [
            913.0851063829787,
            246.1914893617021
        ],
        [
            1055.6382978723404,
            233.4255319148936
        ],
        [
            1923.723404255319,
            210.02127659574467
        ],
        [
            2010.9574468085107,
            229.17021276595744
        ],
        [
            2070.531914893617,
            273.8510638297872
        ],
        [
            2104.574468085106,
            348.31914893617017
        ],
        [
            2166.276595744681,
            1486.6170212765956
        ],
        [
            2117.3404255319147,
            1584.4893617021276
        ],
        [
            2072.659574468085,
            1648.3191489361702
        ],
        [
            857.7659574468084,
            1695.127659574468
        ],
        [
            762.0212765957447,
            1667.468085106383
        ],
        [
            696.063829787234,
            1610.0212765957447
        ],
        [
            668.4042553191489,
            1512.1489361702127
        ],
        [
            619.4680851063829,
            403.6382978723404
        ]
    ]
    area = get_target_area(cap_points)
    #3.针孔坐标集
    target_points=[
        [
          1336.7491166077739,
          963.9575971731449
        ],
        [
          1345.9363957597172,
          963.6042402826855
        ],
        [
          1353.7102473498232,
          963.6042402826855
        ],
        [
          1355.1236749116608,
          952.6501766784452
        ],
        [
          1354.7703180212013,
          943.1095406360424
        ],
        [
          1360.070671378092,
          938.86925795053
        ],
        [
          1367.4911660777384,
          940.9893992932862
        ],
        [
          1373.4982332155478,
          948.4098939929329
        ],
        [
          1381.2720848056538,
          951.9434628975265
        ],
        [
          1388.339222614841,
          945.9363957597172
        ],
        [
          1394.3462897526501,
          943.8162544169611
        ],
        [
          1398.5865724381624,
          945.2296819787986
        ],
        [
          1401.060070671378,
          954.416961130742
        ],
        [
          1399.2932862190812,
          965.017667844523
        ],
        [
          1395.053003533569,
          973.851590106007
        ],
        [
          1390.1060070671379,
          986.5724381625441
        ],
        [
          1390.8127208480564,
          995.0530035335689
        ],
        [
          1393.6395759717313,
          1008.4805653710247
        ],
        [
          1393.6395759717313,
          1018.7279151943462
        ],
        [
          1384.452296819788,
          1017.6678445229682
        ],
        [
          1369.964664310954,
          1012.0141342756184
        ],
        [
          1357.5971731448763,
          1005.6537102473497
        ],
        [
          1355.8303886925794,
          1008.8339222614841
        ],
        [
          1351.590106007067,
          1015.9010600706714
        ],
        [
          1341.3427561837455,
          1016.6077738515901
        ],
        [
          1334.982332155477,
          1014.4876325088339
        ],
        [
          1335.3356890459363,
          1006.3604240282685
        ],
        [
          1338.5159010600707,
          999.2932862190812
        ],
        [
          1337.809187279152,
          988.339222614841
        ],
        [
          1332.155477031802,
          984.452296819788
        ],
        [
          1326.5017667844522,
          978.7985865724381
        ],
        [
          1321.9081272084804,
          972.791519434629
        ],
        [
          1325.4416961130742,
          962.5441696113074
        ]]
    area2=get_target_area(target_points)
    #4.计算缺陷占比，根据相似可以求出缺陷面积
    rate = area2 / area
    true_area = rate*reference_area

    print ('缺陷面积为：%.4f mm2' % true_area)

